# 日志系统代码参考

## 1. 日志助手类
```csharp
/// <summary>
/// 日志助手类
/// </summary>
public class LogHelper
{
    private static readonly LogWriter _writer = new LogWriter();
    
    /// <summary>
    /// 写入调试日志
    /// </summary>
    /// <param name="message">日志消息</param>
    /// <param name="module">模块名称</param>
    public static void Debug(string message, string module = "General")
    {
        WriteLog(LogLevel.Debug, message, module, null);
    }
    
    /// <summary>
    /// 写入信息日志
    /// </summary>
    /// <param name="message">日志消息</param>
    /// <param name="module">模块名称</param>
    public static void Info(string message, string module = "General")
    {
        WriteLog(LogLevel.Info, message, module, null);
    }
    
    /// <summary>
    /// 写入警告日志
    /// </summary>
    /// <param name="message">日志消息</param>
    /// <param name="module">模块名称</param>
    public static void Warn(string message, string module = "General")
    {
        WriteLog(LogLevel.Warn, message, module, null);
    }
    
    /// <summary>
    /// 写入错误日志
    /// </summary>
    /// <param name="message">日志消息</param>
    /// <param name="module">模块名称</param>
    /// <param name="ex">异常信息</param>
    public static void Error(string message, string module = "General", Exception ex = null)
    {
        WriteLog(LogLevel.Error, message, module, ex);
    }
    
    /// <summary>
    /// 写入致命错误日志
    /// </summary>
    /// <param name="message">日志消息</param>
    /// <param name="module">模块名称</param>
    /// <param name="ex">异常信息</param>
    public static void Fatal(string message, string module = "General", Exception ex = null)
    {
        WriteLog(LogLevel.Fatal, message, module, ex);
    }
    
    /// <summary>
    /// 写入日志
    /// </summary>
    /// <param name="level">日志级别</param>
    /// <param name="message">日志消息</param>
    /// <param name="module">模块名称</param>
    /// <param name="ex">异常信息</param>
    private static void WriteLog(LogLevel level, string message, string module, Exception ex)
    {
        _writer.WriteAsync(new LogEntry
        {
            Timestamp = DateTime.Now,
            Level = level,
            Module = module,
            Message = message,
            Exception = ex?.ToString(),
            ProcessId = Process.GetCurrentProcess().Id,
            ThreadId = Thread.CurrentThread.ManagedThreadId
        });
    }
    
    /// <summary>
    /// 写入日志（兼容旧版本）
    /// </summary>
    /// <param name="message">日志消息</param>
    public static void Write(string message)
    {
        Info(message);
    }
}
```

## 2. 日志写入器类
```csharp
/// <summary>
/// 日志写入器类
/// </summary>
internal class LogWriter
{
    private readonly BlockingCollection<LogEntry> _queue = new BlockingCollection<LogEntry>(10000);
    private readonly Task _writeTask;
    private readonly string _logDirectory;
    
    /// <summary>
    /// 构造函数
    /// </summary>
    public LogWriter()
    {
        _logDirectory = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Logs");
        Directory.CreateDirectory(_logDirectory);
        
        _writeTask = Task.Factory.StartNew(WriteLogs, TaskCreationOptions.LongRunning);
    }
    
    /// <summary>
    /// 异步写入日志
    /// </summary>
    /// <param name="entry">日志条目</param>
    public void WriteAsync(LogEntry entry)
    {
        if (!_queue.TryAdd(entry))
        {
            // 队列已满，同步写入
            WriteLogSync(entry);
        }
    }
    
    /// <summary>
    /// 写入日志循环
    /// </summary>
    private void WriteLogs()
    {
        foreach (var entry in _queue.GetConsumingEnumerable())
        {
            WriteLogSync(entry);
        }
    }
    
    /// <summary>
    /// 同步写入日志
    /// </summary>
    /// <param name="entry">日志条目</param>
    private void WriteLogSync(LogEntry entry)
    {
        try
        {
            string fileName = $"HardwareHook_{DateTime.Now:yyyyMMdd}.log";
            string filePath = Path.Combine(_logDirectory, fileName);
            
            string logLine = FormatLogEntry(entry);
            File.AppendAllText(filePath, logLine + Environment.NewLine, Encoding.UTF8);
            
            // 检查日志文件大小，超过阈值则轮转
            CheckLogRotation(filePath);
        }
        catch
        {
            // 日志写入失败，静默处理
        }
    }
    
    /// <summary>
    /// 格式化日志条目
    /// </summary>
    /// <param name="entry">日志条目</param>
    /// <returns>格式化后的日志字符串</returns>
    private string FormatLogEntry(LogEntry entry)
    {
        return $"[{entry.Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{entry.Level}] [{entry.Module}] [PID:{entry.ProcessId}, TID:{entry.ThreadId}] {entry.Message}" +
               (string.IsNullOrEmpty(entry.Exception) ? "" : $"{Environment.NewLine}Exception: {entry.Exception}");
    }
    
    /// <summary>
    /// 检查日志轮转
    /// </summary>
    /// <param name="filePath">日志文件路径</param>
    private void CheckLogRotation(string filePath)
    {
        FileInfo fileInfo = new FileInfo(filePath);
        if (fileInfo.Length > 10 * 1024 * 1024) // 10MB
        {
            string backupPath = Path.Combine(Path.GetDirectoryName(filePath), 
                $"{Path.GetFileNameWithoutExtension(filePath)}_{DateTime.Now:HHmmss}{Path.GetExtension(filePath)}");
            File.Move(filePath, backupPath);
        }
    }
}
```

## 3. 日志相关类
```csharp
/// <summary>
/// 日志级别枚举
/// </summary>
public enum LogLevel
{
    Debug,
    Info,
    Warn,
    Error,
    Fatal
}

/// <summary>
/// 日志条目类
/// </summary>
public class LogEntry
{
    /// <summary>
    /// 时间戳
    /// </summary>
    public DateTime Timestamp { get; set; }
    
    /// <summary>
    /// 日志级别
    /// </summary>
    public LogLevel Level { get; set; }
    
    /// <summary>
    /// 模块名称
    /// </summary>
    public string Module { get; set; }
    
    /// <summary>
    /// 日志消息
    /// </summary>
    public string Message { get; set; }
    
    /// <summary>
    /// 异常信息
    /// </summary>
    public string Exception { get; set; }
    
    /// <summary>
    /// 进程ID
    /// </summary>
    public int ProcessId { get; set; }
    
    /// <summary>
    /// 线程ID
    /// </summary>
    public int ThreadId { get; set; }
}
```