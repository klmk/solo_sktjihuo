# 进程监控代码参考

## 1. 进程监控器类
```csharp
/// <summary>
/// 进程监控器类
/// </summary>
public class ProcessMonitor
{
    private readonly Dictionary<int, ProcessInfo> _processes = new Dictionary<int, ProcessInfo>();
    private readonly Timer _timer;
    private readonly object _lock = new object();
    
    /// <summary>
    /// 进程状态变化事件
    /// </summary>
    public event EventHandler<ProcessStatusChangedEventArgs> ProcessStatusChanged;
    
    /// <summary>
    /// 构造函数
    /// </summary>
    public ProcessMonitor()
    {
        _timer = new Timer(MonitorCallback, null, 0, 5000); // 每5秒检查一次
    }
    
    /// <summary>
    /// 添加要监控的进程
    /// </summary>
    /// <param name="processId">进程ID</param>
    /// <param name="unloadEventName">卸载事件名称</param>
    public void AddProcess(int processId, string unloadEventName)
    {
        lock (_lock)
        {
            if (!_processes.ContainsKey(processId))
            {
                _processes[processId] = new ProcessInfo
                {
                    ProcessId = processId,
                    UnloadEventName = unloadEventName,
                    Status = ProcessStatus.Injected,
                    LastCheckTime = DateTime.Now
                };
            }
        }
    }
    
    /// <summary>
    /// 移除监控的进程
    /// </summary>
    /// <param name="processId">进程ID</param>
    public void RemoveProcess(int processId)
    {
        lock (_lock)
        {
            _processes.Remove(processId);
        }
    }
    
    /// <summary>
    /// 获取进程信息
    /// </summary>
    /// <param name="processId">进程ID</param>
    /// <returns>进程信息</returns>
    public ProcessInfo GetProcessInfo(int processId)
    {
        lock (_lock)
        {
            _processes.TryGetValue(processId, out var info);
            return info;
        }
    }
    
    /// <summary>
    /// 获取所有监控的进程
    /// </summary>
    /// <returns>进程信息列表</returns>
    public List<ProcessInfo> GetAllProcesses()
    {
        lock (_lock)
        {
            return _processes.Values.ToList();
        }
    }
    
    /// <summary>
    /// 监控回调函数
    /// </summary>
    /// <param name="state">状态对象</param>
    private void MonitorCallback(object state)
    {
        lock (_lock)
        {
            List<int> deadProcesses = new List<int>();
            
            foreach (var kvp in _processes)
            {
                int processId = kvp.Key;
                ProcessInfo info = kvp.Value;
                
                try
                {
                    Process process = Process.GetProcessById(processId);
                    info.Status = ProcessStatus.Running;
                    info.LastCheckTime = DateTime.Now;
                    
                    // 检查进程是否正常运行
                    if (process.HasExited)
                    {
                        info.Status = ProcessStatus.Exited;
                        deadProcesses.Add(processId);
                        OnProcessStatusChanged(processId, ProcessStatus.Exited);
                    }
                }
                catch
                {
                    // 进程不存在
                    info.Status = ProcessStatus.Exited;
                    deadProcesses.Add(processId);
                    OnProcessStatusChanged(processId, ProcessStatus.Exited);
                }
            }
            
            // 移除已退出的进程
            foreach (int processId in deadProcesses)
            {
                _processes.Remove(processId);
                LogHelper.Info($"进程 {processId} 已退出，移除监控", "ProcessMonitor");
            }
        }
    }
    
    /// <summary>
    /// 触发进程状态变化事件
    /// </summary>
    /// <param name="processId">进程ID</param>
    /// <param name="status">新状态</param>
    private void OnProcessStatusChanged(int processId, ProcessStatus status)
    {
        ProcessStatusChanged?.Invoke(this, new ProcessStatusChangedEventArgs(processId, status));
    }
    
    /// <summary>
    /// 停止监控
    /// </summary>
    public void Stop()
    {
        _timer.Dispose();
    }
}
```

## 2. 进程信息类
```csharp
/// <summary>
/// 进程信息类
/// </summary>
public class ProcessInfo
{
    /// <summary>
    /// 进程ID
    /// </summary>
    public int ProcessId { get; set; }
    
    /// <summary>
    /// 卸载事件名称
    /// </summary>
    public string UnloadEventName { get; set; }
    
    /// <summary>
    /// 进程状态
    /// </summary>
    public ProcessStatus Status { get; set; }
    
    /// <summary>
    /// 最后检查时间
    /// </summary>
    public DateTime LastCheckTime { get; set; }
    
    /// <summary>
    /// 获取进程名称
    /// </summary>
    /// <returns>进程名称</returns>
    public string GetProcessName()
    {
        try
        {
            Process process = Process.GetProcessById(ProcessId);
            return process.ProcessName;
        }
        catch
        {
            return "Unknown";
        }
    }
}
```

## 3. 进程状态枚举
```csharp
/// <summary>
/// 进程状态枚举
/// </summary>
public enum ProcessStatus
{
    /// <summary>
    /// 未知状态
    /// </summary>
    Unknown,
    
    /// <summary>
    /// 已注入
    /// </summary>
    Injected,
    
    /// <summary>
    /// 运行中
    /// </summary>
    Running,
    
    /// <summary>
    /// 已退出
    /// </summary>
    Exited,
    
    /// <summary>
    /// 错误
    /// </summary>
    Error
}
```

## 4. 进程状态变化事件参数
```csharp
/// <summary>
/// 进程状态变化事件参数
/// </summary>
public class ProcessStatusChangedEventArgs : EventArgs
{
    /// <summary>
    /// 进程ID
    /// </summary>
    public int ProcessId { get; }
    
    /// <summary>
    /// 新状态
    /// </summary>
    public ProcessStatus Status { get; }
    
    /// <summary>
    /// 构造函数
    /// </summary>
    /// <param name="processId">进程ID</param>
    /// <param name="status">新状态</param>
    public ProcessStatusChangedEventArgs(int processId, ProcessStatus status)
    {
        ProcessId = processId;
        Status = status;
    }
}
```

## 5. 应用池回收监控
```csharp
/// <summary>
/// 应用池回收监控类
/// </summary>
public class AppPoolMonitor
{
    private readonly Timer _timer;
    private readonly HashSet<int> _injectedProcesses = new HashSet<int>();
    private readonly object _lock = new object();
    private Action<int> _injectCallback;
    
    /// <summary>
    /// 构造函数
    /// </summary>
    /// <param name="injectCallback">注入回调函数</param>
    public AppPoolMonitor(Action<int> injectCallback)
    {
        _injectCallback = injectCallback;
        _timer = new Timer(MonitorCallback, null, 0, 30000); // 每30秒检查一次
    }
    
    /// <summary>
    /// 添加已注入的w3wp.exe进程
    /// </summary>
    /// <param name="processId">进程ID</param>
    public void AddInjectedProcess(int processId)
    {
        lock (_lock)
        {
            _injectedProcesses.Add(processId);
        }
    }
    
    /// <summary>
    /// 移除已注入的w3wp.exe进程
    /// </summary>
    /// <param name="processId">进程ID</param>
    public void RemoveInjectedProcess(int processId)
    {
        lock (_lock)
        {
            _injectedProcesses.Remove(processId);
        }
    }
    
    /// <summary>
    /// 监控回调函数
    /// </summary>
    /// <param name="state">状态对象</param>
    private void MonitorCallback(object state)
    {
        try
        {
            // 获取所有w3wp.exe进程
            var w3wpProcesses = Process.GetProcessesByName("w3wp");
            var currentProcessIds = new HashSet<int>(w3wpProcesses.Select(p => p.Id));
            
            lock (_lock)
            {
                // 检查是否有新的w3wp.exe进程
                foreach (var process in w3wpProcesses)
                {
                    if (!_injectedProcesses.Contains(process.Id))
                    {
                        // 新的w3wp.exe进程，需要重新注入
                        LogHelper.Info($"检测到新的w3wp.exe进程，PID：{process.Id}", "AppPoolMonitor");
                        _injectCallback?.Invoke(process.Id);
                        _injectedProcesses.Add(process.Id);
                    }
                }
                
                // 移除已结束的进程
                _injectedProcesses.RemoveWhere(pid => !currentProcessIds.Contains(pid));
            }
        }
        catch (Exception ex)
        {
            LogHelper.Error($"监控应用池回收异常：{ex.Message}", "AppPoolMonitor");
        }
    }
    
    /// <summary>
    /// 停止监控
    /// </summary>
    public void Stop()
    {
        _timer.Dispose();
    }
}
```