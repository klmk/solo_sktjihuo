# Windows硬件信息模拟Hook工具开发文档

## 一、项目现状分析

### 1.1 项目结构

当前项目采用精简架构，聚焦核心功能：

| 程序名称 | 类型 | 核心作用 | 状态 |
|---------|------|---------|------|
| 硬件信息模拟Hook工具（主程序） | WinForm可视化应用 | 核心操作端：进程选择、DLL注入、Hook管理、状态展示、日志查看 | 已实现 |
| 硬件信息测试程序 | 控制台应用 | 验证端：采集硬件信息、对比Hook前后结果、支持命令行调用 | 已实现 |
| Hook核心DLL | 类库 | 实现API拦截和硬件信息模拟 | 已实现 |

### 1.2 已实现功能

- ✅ 硬件信息读取与配置导出
- ✅ 进程列表加载与刷新
- ✅ DLL注入基础框架
- ✅ 核心API Hook实现（CPU/硬盘/MAC/注册表）
- ✅ 可视化操作界面
- ✅ 基础日志系统
- ✅ 测试程序
- ✅ 异常处理与边界情况

### 1.3 待完善功能

- ⏳ Hook功能稳定性优化
- ⏳ 基础性能优化
- ⏳ 完整的测试验证流程

## 二、开发环境要求

### 2.1 系统要求

- **操作系统**：Windows 7/8/10/11 x64 系统
- **运行时**：.NET Framework 4.8
- **权限**：管理员权限（必须，以确保能够注入目标进程）

### 2.2 开发工具

- Visual Studio 2019 或更高版本
- .NET Framework 4.8 开发工具包
- NuGet 包管理器

### 2.3 依赖项

| 依赖项 | 版本 | 用途 |
|-------|------|------|
| EasyHook | 2.6.6 | DLL注入和API Hook框架 |
| Newtonsoft.Json | 13.0.1 | JSON配置文件处理 |

## 三、核心功能实现指南

### 3.1 API Hook实现

#### 3.1.1 Hook安装流程

1. **DLL注入**：使用EasyHook的`RemoteHooking.Inject`方法将核心DLL注入目标进程
2. **入口点初始化**：`EntryPoint.Run`方法被调用，加载配置文件
3. **Hook安装**：调用`HookManager.InstallAll`安装所有API Hook
4. **等待卸载信号**：创建事件等待句柄，等待卸载信号

#### 3.1.2 核心API拦截

| API类别 | 拦截的API | 功能 |
|--------|----------|------|
| CPU/系统 | GetSystemInfo, GetNativeSystemInfo | 模拟CPU核心数等信息 |
| 硬盘 | GetVolumeInformationW, DeviceIoControl | 模拟硬盘序列号等信息 |
| 网卡/MAC | GetAdaptersInfo, GetIfTable | 模拟MAC地址 |
| 主板/BIOS | RegOpenKeyEx, RegQueryValueEx | 模拟主板序列号等信息 |

#### 3.1.3 Hook回调函数设计

Hook回调函数设计遵循以下核心原则：
1. **先调用原始API**：获取真实硬件信息
2. **异常处理**：确保异常不会导致目标进程崩溃
3. **内存管理**：合理管理内存资源，避免内存泄露
4. **简洁高效**：最小化回调函数执行时间，确保目标进程稳定运行

### 3.2 配置管理

#### 3.2.1 配置文件结构

```json
{
  "Cpu": {
    "Model": "Intel(R) Core(TM) i9-12900K",
    "CoreCount": 16,
    "CpuId": "BFEBFBFF000A06E9"
  },
  "Disk": {
    "Serial": "1234567890ABCDEF"
  },
  "Mac": {
    "Address": "00:11:22:33:44:55"
  },
  "Motherboard": {
    "Serial": "MB-2025-12345678"
  }
}
```

#### 3.2.2 配置加载与验证

配置加载与验证实现了以下功能：
1. **配置文件检查**：验证配置文件是否存在
2. **配置解析**：使用Newtonsoft.Json解析JSON配置
3. **配置验证**：确保配置项的有效性
4. **错误处理**：提供详细的错误信息

### 3.3 DLL注入实现

#### 3.3.1 注入流程

1. **验证目标进程**：检查进程是否存活
2. **验证配置文件**：确保配置文件有效
3. **解析核心DLL路径**：找到HardwareHook.Core.dll
4. **生成卸载事件名称**：用于后续卸载Hook
5. **执行注入**：使用EasyHook的RemoteHooking.Inject方法

#### 3.3.2 卸载流程

1. **生成卸载事件名称**：与注入时使用的名称对应
2. **设置事件信号**：通知目标进程中的Hook卸载

## 四、测试策略

### 4.1 测试工具

- **硬件信息测试程序（HWInfoTest.exe）**：用于快速验证硬件信息模拟效果

### 4.2 主程序测试流程

#### 4.2.1 基础功能测试

1. **硬件信息读取测试**：
   - 点击"读取硬件信息"按钮
   - 验证界面显示的硬件信息是否正确
   - 验证日志记录是否完整

2. **配置导出测试**：
   - 读取硬件信息后，点击"导出配置模板"
   - 验证导出的JSON文件格式是否正确
   - 验证配置文件内容是否与读取的硬件信息一致

3. **进程管理测试**：
   - 点击"刷新进程列表"
   - 验证进程列表是否正确显示
   - 验证进程状态显示是否正确

4. **DLL注入测试**：
   - 选择一个测试进程（如notepad.exe）
   - 选择配置文件
   - 点击"模拟"按钮
   - 验证注入是否成功
   - 验证进程状态是否更新为"模拟中"

5. **Hook功能测试**：
   - 注入成功后，运行HWInfoTest.exe
   - 验证测试程序显示的硬件信息是否与配置文件一致
   - 对比注入前后的硬件信息

6. **卸载测试**：
   - 点击"停止模拟"按钮
   - 验证进程状态是否更新为"未模拟"
   - 再次运行HWInfoTest.exe，验证硬件信息是否恢复真实值

### 4.3 测试用例

| 测试用例 | 预期结果 | 验证方法 |
|---------|---------|----------|
| 模拟CPU核心数 | HWInfoTest显示配置的核心数 | 运行HWInfoTest.exe --cpu |
| 模拟硬盘序列号 | HWInfoTest显示配置的序列号 | 运行HWInfoTest.exe --disk |
| 模拟MAC地址 | HWInfoTest显示配置的MAC地址 | 运行HWInfoTest.exe --mac |
| 模拟主板序列号 | HWInfoTest显示配置的序列号 | 运行HWInfoTest.exe --bios |
| 注入notepad.exe | 注入成功，状态更新为"模拟中" | 查看进程状态 |
| 卸载Hook | 状态更新为"未模拟"，硬件信息恢复真实值 | 再次运行HWInfoTest.exe |

## 五、常见问题与解决方案

### 5.1 注入失败

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|----------|
| 目标进程不存在或已退出 | 进程已结束 | 确认进程是否存活，重新选择进程 |
| 配置文件无效 | 配置文件不存在或格式错误 | 选择有效的配置文件，确保JSON格式正确 |
| 找不到Hook核心DLL | DLL文件不存在 | 确保HardwareHook.Core.dll在正确位置 |
| 注入失败：拒绝访问 | 权限不足 | 以管理员身份运行主程序 |

### 5.2 Hook功能未生效

| 问题现象 | 可能原因 | 解决方案 |
|---------|---------|----------|
| 硬件信息未改变 | Hook未成功安装 | 检查日志，确认Hook安装是否成功 |
| 部分硬件信息未改变 | 对应的API未被调用 | 使用测试程序验证，或检查目标程序使用的API |

### 5.3 稳定性问题

| 问题现象 | 可能原因 | 解决方案 |
|---------|---------|----------|
| 目标进程崩溃 | Hook回调函数异常未捕获 | 确保所有Hook回调函数都有try-catch |
| 主程序崩溃 | 未处理异常 | 确保主程序中的所有操作都有异常处理 |
| 注入后目标进程无响应 | Hook回调函数执行时间过长 | 优化Hook回调函数，避免耗时操作 |

## 六、进程适配说明

### 6.1 支持范围

当前版本支持以下类型的进程：
- **标准用户进程**：如notepad.exe等普通应用程序
- **32位和64位进程**：通过EasyHook框架自动适配

### 6.2 适配原则

1. **稳定性优先**：确保注入不会导致目标进程崩溃
2. **权限匹配**：确保主程序权限不低于目标进程
3. **简单可靠**：采用成熟的注入方法，避免复杂适配

### 6.3 注意事项

- 以管理员身份运行主程序以获得最佳兼容性
- 避免注入系统关键进程，以防影响系统稳定性
- 对于特殊进程（如w3wp.exe），可能需要额外的权限和处理

## 七、开发流程与注意事项

### 7.1 开发流程

1. **环境搭建**：
   - 安装Visual Studio 2019或更高版本
   - 安装.NET Framework 4.8开发工具包
   - 克隆项目代码
   - 还原NuGet包

2. **代码编译**：
   - 设置解决方案配置为Debug
   - 设置平台目标为x64
   - 构建解决方案

3. **测试验证**：
   - 运行主程序
   - 执行基础功能测试
   - 验证所有功能是否正常

4. **稳定性测试**：
   - 长时间运行测试
   - 异常场景测试

### 7.2 核心注意事项

1. **权限问题**：
   - 始终以管理员身份运行主程序

2. **稳定性问题**：
   - 所有Hook回调函数必须包裹try-catch
   - 避免在Hook回调中执行耗时操作
   - 使用异步日志写入

3. **内存管理**：
   - 避免内存泄漏
   - 及时释放不再使用的资源

4. **重复操作防护**：
   - 避免重复注入同一进程
   - 避免重复卸载未注入的进程

5. **配置文件管理**：
   - 确保配置文件格式正确
   - 验证配置文件内容有效性

6. **日志管理**：
   - 记录足够的日志信息
   - 避免日志过多影响性能

## 八、总结与后续计划

### 8.1 项目总结

当前项目已经实现了Windows硬件信息模拟Hook工具的核心功能，包括：

- ✅ 硬件信息读取与配置导出
- ✅ 进程管理与DLL注入
- ✅ API Hook实现（CPU/硬盘/MAC/注册表）
- ✅ 可视化操作界面
- ✅ 基础日志系统
- ✅ 测试程序
- ✅ 异常处理与边界情况

项目采用精简架构，聚焦核心功能，代码组织合理，已经具备了稳定的硬件信息模拟能力。

### 8.2 后续开发计划

#### 8.2.1 近期计划（1-2周）

1. **Hook功能稳定性优化**：
   - 增强Hook回调函数的异常处理
   - 优化内存管理，避免内存泄漏
   - 提高注入成功率和稳定性

2. **基础性能优化**：
   - 减少Hook回调函数执行时间
   - 优化内存使用
   - 减少日志写入频率

3. **完整的测试验证流程**：
   - 完善测试用例
   - 执行长时间运行测试
   - 验证所有功能的稳定性

#### 8.2.2 长期规划（可选）

1. **功能扩展**：
   - 支持更多硬件参数的模拟
   - 增加批量操作功能
   - 改进用户界面设计

2. **兼容性提升**：
   - 增强对特殊进程的支持
   - 提高系统兼容性

### 8.3 开发建议

1. **稳定性优先**：确保基础功能稳定后，再进行功能扩展
2. **测试驱动**：每个功能开发完成后，立即进行测试验证
3. **代码质量**：保持代码整洁，添加必要的注释
4. **文档同步**：定期更新文档，确保与代码一致
5. **循序渐进**：按照优先级顺序开发，避免同时处理过多任务

---

## 九、文档维护

### 9.1 文档结构

- **开发文档.md**：主文档，包含架构设计、功能描述、流程说明等内容
- **测试用例/**：测试相关文件目录
- **代码参考/**：代码示例和参考实现目录

### 9.2 文档维护

1. **定期更新**：代码变更时同步更新相关文档
2. **版本控制**：使用版本控制工具管理文档文件
3. **一致性**：确保文档与代码的一致性

---

**开发团队注意事项**：

1. 开发过程中严格遵循本文档的指导
2. 遇到问题时，参考"常见问题与解决方案"部分
3. 开发完成后，执行完整的测试流程
4. 确保代码符合项目的代码规范

---

**最后更新时间**：2026年2月25日